---
title: 'CS6190: Probabilistic Modeling Homework 2
Bayesian Networks'
author: "Gopal Menon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
header-includes:
- \usepackage{mathtools}
- \usepackage{amsmath}
- \usepackage{dirtytalk}
- \DeclareMathOperator{\Unif}{Unif}
- \DeclareMathOperator{\E}{E}
- \DeclareMathOperator{\Var}{Var}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\hrule

\section*{Written Part}

\begin{enumerate}

\item The total probability of the network is given by
\textbf{Hint:} Start with the identity $\int p(x) dx = 1$, and take the derivative with respect to $\eta$.

$$ 
\begin{aligned} 
p(Beysian\;Network)&=p(income)p(smoke|income)p(exercise|income)p(bmi|income,exercise)\\&\times p(blood\;pressure|exercise, income, smoking)p(cholesterol| exercise, income, smoking) \\ &\times p(diabetes | bmi)p(stroke | bmi, bp, cholesterol)p(attack | bmi, bp, cholesterol)\\ &\times p(angina | bmi, bp, cholesterol)
\end{aligned}
$$
The total probability distribution requires the product of $10$ random variables. If the probabilities are multiplied as shown above, the probability table will have $10$ variables. Number of allowed states for the random variables are:

\end{enumerate}

```{r init, echo=FALSE, results='asis'}
source("BRFSS Bayes Net.R")
load_libraries()
survey_variables = c("income", "exercise", "smoke", "bmi", "bp", "cholesterol", 
                     "angina", "stroke", "attack", "diabetes")
survey_variables_states = c(8, 2, 2, 4, 4, 2, 2, 2, 2, 4)
beysian_network_vars_states = data.frame(survey_variables, survey_variables_states)
names(beysian_network_vars_states) = c("Survey Variable", "Number of states")
print(kable(beysian_network_vars_states, caption = "CDC Survey Variable states"))
```

The maximum number of rows in the probability distribution table for the above variables will be the product of the number of allowed states - $8\times2\times2\times4\times4\times2\times2\times2\times2\times4=32768$. This is the number of probabilities that are needed to store the full joint distribution.

\begin{enumerate}
  \item[2.] For each of the four health outcomes (diabetes, stroke, heart attack, angina) 
  \begin{enumerate}
    \item Probability of the outcome if I have bad habits (smoke and don’t exercise)? How about if I have good habits (don’t smoke and do exercise)?
  \end{enumerate}
\end{enumerate}

```{r q1q2, echo=FALSE, results='asis'}

## 1.
# Create the Bayesian network to analyze the survey results. It will be the product of 
# all the probabilities corresponding to the full joint distribution. 
risk_factors_bayes_net = create_bayes_net()

## 2.
# For each of the four health outcomes (diabetes, stroke, heart attack, angina), answer the following by 
# querying the network

## (a)
# What is the probability of the outcome if I have bad habits (smoke and don’t exercise)? 
outcome_tables = get_health_outcomes(bayes_net=risk_factors_bayes_net, 
                                     health_outcomes=health_outcomes, 
                                     observe_variables=habit_variables, 
                                     observe_values=bad_habit_values)
table_counter = 0
for (factor_table in outcome_tables) {
  table_counter = table_counter + 1
  caption_text = paste("Probability for ", health_outcomes[table_counter], " with smoking and no exercise")
  print(kable(factor_table, caption = caption_text))  
}

# How about if I have good habits (don’t smoke and do exercise)?
outcome_tables = get_health_outcomes(bayes_net=risk_factors_bayes_net, health_outcomes=health_outcomes, observe_variables=habit_variables, observe_values=good_habit_values)
table_counter = 0
for (factor_table in outcome_tables) {
  table_counter = table_counter + 1
  caption_text = paste("Probability for ", health_outcomes[table_counter], " with no smoking and exercise")
  print(kable(factor_table, caption = caption_text))  
}
```

\begin{enumerate}

  \item[(b)] What is the probability of the outcome if I have poor health (high blood pressure, high cholesterol, and overweight)? What if I have good health (low blood pressure, low cholesterol, and normal weight)?

\end{enumerate}

```{r q2contd, echo=FALSE, results='asis'}

## (b)
# What is the probability of the outcome if I have poor health (high blood pressure, high cholesterol, and overweight)?
outcome_tables = get_health_outcomes(bayes_net=risk_factors_bayes_net, health_outcomes=health_outcomes, observe_variables=health_variables, observe_values=bad_health_values)
table_counter = 0
for (factor_table in outcome_tables) {
  table_counter = table_counter + 1
  caption_text = paste("Probability for ", health_outcomes[table_counter], " with bad health")
  print(kable(factor_table, caption = caption_text))  
}

# What if I have good health (low blood pressure, low cholesterol, and normal weight)?
outcome_tables = get_health_outcomes(bayes_net=risk_factors_bayes_net, health_outcomes=health_outcomes, observe_variables=health_variables, observe_values=good_health_values)
table_counter = 0
for (factor_table in outcome_tables) {
  table_counter = table_counter + 1
  caption_text = paste("Probability for ", health_outcomes[table_counter], " with good health")
  print(kable(factor_table, caption = caption_text))  
}
```


\begin{enumerate}

  \item[3.] Evaluate the effect a person’s income has on their probability of having one of the four health outcomes (diabetes, stroke, heart attack, angina). For each of these four outcomes, plot their probability given income status (your horizontal axis should be $i = 1,2,\ldots,8$, and your vertical axis should be $P(y = 1|income = i)$, where $y$ is the outcome). What can you conclude?

\end{enumerate}

```{r q3, echo=FALSE, results='asis'}
# Outcome probabilities by income level
diabetes_probability_by_income = numeric()
stroke_probability_by_income = numeric()
attack_probability_by_income = numeric()
angina_probability_by_income = numeric()

# For each income level
for (income_level in 1:8) {
  
  # Find the probability of a bad outcome
  outcome_tables = get_health_outcomes(bayes_net=risk_factors_bayes_net, 
                                       health_outcomes=health_outcomes, 
                                       observe_variables=c("income"), 
                                       observe_values=c(income_level))
  
  # Store diabetes outcome probability
  diabetes_factor_table = outcome_tables[[which(health_outcomes == "diabetes")]]
  probability_value = diabetes_factor_table[which(diabetes_factor_table[["diabetes"]] == diabetes_values[1]), 1]
  diabetes_probability_by_income[income_level] = probability_value
  
  # Stroke stroke outcome probability
  stroke_factor_table = outcome_tables[[which(health_outcomes == "stroke")]]
  probability_value = stroke_factor_table[which(stroke_factor_table[["stroke"]] == stroke_values[1]), 1]
  stroke_probability_by_income[income_level] = probability_value
  
  # Store heart attack outcome probability
  attack_factor_table = outcome_tables[[which(health_outcomes == "attack")]]
  probability_value = attack_factor_table[which(attack_factor_table[["attack"]] == attack_values[1]), 1]
  attack_probability_by_income[income_level] = probability_value
  
  # Store angina outcome probability
  angina_factor_table = outcome_tables[[which(health_outcomes == "angina")]]
  probability_value = angina_factor_table[which(angina_factor_table[["angina"]] == angina_values[1]), 1]
  angina_probability_by_income[income_level] = probability_value

}

# Plot the health outcome probabilities by income level
par(mar=c(8,3,1,6))
plot(1:8, diabetes_probability_by_income, main="Health Outcome Probability by Income Level", type='l', col="red", xlab="", ylab="Outcome Probability", xaxt="n", ylim=c(0.03,0.16), lwd=3)
lines(1:8, stroke_probability_by_income, col="blue", lwd=3)
lines(1:8, attack_probability_by_income, col="green", lwd=3)
lines(1:8, angina_probability_by_income, col="magenta", lwd=3)
axis(side=1, at=1:8, labels=c("< $10,000","$10,000 - $15,000","$15,000, - $20,000","$20,000 - $25,000","$25,000 - $35,000","$35,000 - $50,000","$50,000 - $75,000","> $75,000"), las=2)
legend("topright", xpd=TRUE, text.width=0.9, inset=c(-0.2,0), legend=c("diabetes", "angina", "attack", "stroke"), col = c("red", "magenta", "green", "blue"), lwd=3, bg="white")
```

It looks like overall the probability of a bad health outcome reduces with increasing income. However, it looks like the probability first increases from the lowest to the next highest income and then reduces.
